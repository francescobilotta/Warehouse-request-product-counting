<!DOCTYPE html>
<html lang="it">
  <head>
    <title>Warehouse count asker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="icon" href="../../assets/img/favicon.png" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/css/selectize.bootstrap4.min.css" />

    <link href="../../assets/css/common.css?1323" rel="stylesheet" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/js/standalone/selectize.min.js"></script>

    <script src="../../assets/js/request.js?12233334"></script>
    <script src="../../assets/js/generators.js?143234"></script>
    <script src="../../assets/js/record_edit.js?125634"></script>
    <script src="../../assets/js/append_img_request_state.js?74232534"></script>
    <script src="../../assets/js/queries.js?1332534"></script>
    <script>
      function make_editable(element) {
        $("#edit-popup").show();
        $("#popup").removeClass();
        $("#popup").addClass(element.attr("id"));

        //For popup
        const table_data_requester = new Requester(function (result) {
          //Get today data
          const now = new Date();
          const day = ("0" + now.getDate()).slice(-2);
          const month = ("0" + (now.getMonth() + 1)).slice(-2);
          const today = now.getFullYear() + "-" + month + "-" + day;
          var image_size = "40px";

          //Product Info
          $("#prod_code").val(result.results[0].productCode);
          $("#prod_name").val(result.results[0].productName);
          $("#prod_variant").val(result.results[0].productFlavour);
          $("#notes").val(result.results[0].notes);
          $("#date_due").val(result.results[0].dueDate.split(" ")[0]).attr({
            min: today,
          });
          $("#date_creation").val(creationDate);

          //EXPECTED COUNT
          const expected_count_requester = new Requester(function (result) {
            $("#expected_count").val(result.results.N_TOT[0]);
          });
          expected_count_requester.query({
            q_name: "warehouse_expected_count",
            q_data: {
              "f.productCode": result.results[0].productCode,
              "f.productFlavour": result.results[0].productFlavour,
              "f.currentYear": now.getFullYear(),
            },
          });
          //EXPECTED GROUND COUNT
          const expected_ground_count_requester = new Requester(function (result) {
            if (result.PRELEVATO) {
              let ground_count = result.results.N_TOT.reduce((x, y) => x + y);
              $("#expected_ground_count").val(ground_count);
            } else {
              $("#expected_ground_count").val(0);
            }
          });
          expected_ground_count_requester.query({
            q_name: "warehouse_expected_ground_count",
            q_data: {
              "d.lastYear": now.getFullYear() - 1,
              "d.currentYear": now.getFullYear(),
              "f.productCode": result.results[0].productCode,
              "f.productFlavour": result.results[0].productFlavour,
            },
          });
          //EXPECTED LOCATION
          const expected_location = new Requester(function (result) {
            console.log(result);
          });
          expected_location.query({
            q_name: "warehouse_get_product_location",
            q_data: {
              "f.productCode": result.results[0].productCode,
              "f.productFlavour": result.results[0].productFlavour,
            },
          });

          //Hide all buttons before selecting which to show counted_items
          $("#btn-count").hide();

          //RequestState
          $("#req_id").val(element.attr("id"));
          switch (result.results[0].requestState) {
            case "countRequest":
              append_img_request_state("request_state", "../../assets/img/countRequest.png", image_size, "Asked for count");
              $("#btn-count").show();
              break;
            case "recountRequest":
              append_img_request_state("request_state", "../../assets/img/recountRequest.png", image_size, "Asked for recount");
              $("#btn-count").show();
              break;
            default:
          }
        });
        table_data_requester.query({
          q_name: "warehouse_requests_details",
          q_data: {
            "f.requestId": element.attr("id"),
          },
        });
      }

      function register_clicks() {
        $(".table-row").dblclick(function (e) {
          make_editable($(this));
        });

        $("#edit-popup").click(function (e) {
          if (e.target === this) {
            $(this).hide();
          }
        });

        $(".exit-button").click(function (e) {
          if (e.target === this) {
            $("#edit-popup").hide();
          }
        });
      }

      //Get table data
      $(document).ready(function () {
        $("#edit-popup").hide();

        $("#btn-count").click((e) => {
          if ($.isNumeric($("#counted_items").val()) && $("#counted_items").val() > 0) {
            warehouseCount($("#popup").attr("class"), $("#counted_items").val(), result.results[0].requestState);
            location.reload();
          } else {
            alert("No empty fields or negatives numbers are accepted");
          }
        });

        const table_headers_strings = {
          STATUS: "requestState",
          PRODUCT: "productName",
          FLAVOUR: "productFlavour",
          NOTES: "notes",
          "REQUEST DATE [dd/mm/yyyy]": "requestDate",
          "DUE DATE [dd/mm/yyyy]": "dueDate",
          "EXPECTED IN TOTAL": "expectedCount",
          "READY TO BE SHIPPED": "expectedGroundCount",
        };
        const table_data_requester = new Requester((result) => {
          table_maker(result.results, "request-table-container", table_headers_strings);
          register_clicks();
        });
        table_data_requester.query({ q_name: "warehouse_requests" });
      });
    </script>
  </head>
  <body>
    <main role="main" class="container">
      <!--  -->
      <!-- Popup -->
      <!--  -->
      <div id="edit-popup" class="popup-container">
        <div id="popup">
          <div class="card-section exit-button-wrapper">
            <div class="card-header-title">Details</div>
            <div class="exit-button">&times;</div>
          </div>
          <div id="popup-data" class="card-section form-holder">
            <!-- Request info -->
            <div class="form-group row">
              <label for="req_id" class="col-1 col-form-label">Request Id</label>
              <div class="row col-11">
                <div class="input-group">
                  <div class="input-group-prepend" id="request_state"></div>
                  <input id="req_id" name="req_id" type="text" class="form-control" aria-describedby="req_idHelpBlock" required="required" readonly />
                </div>
                <span id="req_idHelpBlock" class="form-text text-muted">Assigned id to the current request</span>
              </div>
            </div>

            <!-- Product info -->
            <div class="row">
              <label class="col-1 col-form-label">Product Info</label>

              <div class="row col-11">
                <div class="form-group col no-gutters">
                  <label class="col-12 col-form-label" for="prod_code">Product Code</label>
                  <div class="col-12">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <div class="input-group-text"><i class="fa fa-barcode"></i></div>
                      </div>
                      <input id="prod_code" name="prod_code" type="text" class="form-control" aria-describedby="prod_codeHelpBlock" required="required" readonly />
                    </div>
                    <span id="prod_codeHelpBlock" class="form-text text-muted">Code assigned to the product</span>
                  </div>
                </div>

                <div class="form-group col no-gutters">
                  <label class="col-12 col-form-label" for="prod_name">Product Name</label>
                  <div class="col-12">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <div class="input-group-text"><i class="fa fa-tag"></i></div>
                      </div>
                      <input id="prod_name" name="prod_name" type="text" class="form-control" aria-describedby="prod_nameHelpBlock" required="required" readonly />
                    </div>
                    <span id="prod_nameHelpBlock" class="form-text text-muted">Descriptive product name</span>
                  </div>
                </div>

                <div class="form-group col no-gutters">
                  <label for="prod_variant" class="col-12 col-form-label">Product flavour</label>
                  <div class="col-12">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <div class="input-group-text">
                          <i class="fa fa-archive"></i>
                        </div>
                      </div>
                      <input
                        id="prod_variant"
                        name="prod_variant"
                        type="text"
                        class="form-control"
                        aria-describedby="prod_variantHelpBlock"
                        required="required"
                        readonly
                      />
                    </div>
                    <span id="prod_variantHelpBlock" class="form-text text-muted">The specific variant of this product</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div class="form-group row" style="margin-top: 13px !important">
              <label for="notes" class="col-1 col-form-label">Notes</label>
              <div class="row col-11">
                <div class="input-group">
                  <textarea id="notes" name="notes" cols="20" rows="2" class="form-control" aria-describedby="notesHelpBlock" readonly></textarea>
                </div>
              </div>
            </div>

            <!-- Dates -->
            <div class="row">
              <label class="col-1 col-form-label">Dates</label>
              <div class="row col-11">
                <div class="form-group col no-gutters">
                  <label for="date_due" class="col-12 col-form-label">Due Date [mm/dd/yyyy]</label>
                  <div class="col-12">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <div class="input-group-text">
                          <i class="fa fa-calendar"></i>
                        </div>
                      </div>
                      <input id="date_due" name="date_due" type="date" class="form-control" aria-describedby="date_dueHelpBlock" required="required" readonly />
                    </div>
                  </div>
                </div>

                <div class="form-group col no-gutters">
                  <label for="date_creation" class="col-12 col-form-label">Creation Date [mm/dd/yyyy]</label>
                  <div class="col-12">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <div class="input-group-text">
                          <i class="fa fa-calendar"></i>
                        </div>
                      </div>
                      <input
                        id="date_creation"
                        name="date_creation"
                        type="text"
                        aria-describedby="date_creationHelpBlock"
                        required="required"
                        class="form-control"
                        readonly
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Expected Counts -->
            <div class="row">
              <label class="col-1 col-form-label">Counts</label>
              <div class="row col-11">
                <div class="form-group col no-gutters">
                  <label for="expected_count" class="col-12 col-form-label">Expected</label>
                  <div class="col-12">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <div class="input-group-text">
                          <i class="fa fa-bar-chart-o"></i>
                        </div>
                      </div>
                      <input id="expected_count" name="expected_count" type="number" class="form-control" aria-describedby="expected_countHelpBlock" readonly />
                    </div>
                  </div>
                </div>

                <div class="form-group col no-gutters">
                  <label for="expected_ground_count" class="col-12 col-form-label">Ready to be shipped</label>
                  <div class="col-12">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <div class="input-group-text">
                          <i class="fa fa-refresh"></i>
                        </div>
                      </div>
                      <input id="expected_ground_count" name="expected_ground_count" type="number" class="form-control" readonly />
                    </div>
                  </div>
                </div>

                <div class="form-group col no-gutters">
                  <label class="col-12 col-form-label">Counted</label>
                  <div class="col-12">
                    <div class="input-group">
                      <div class="input-group-prepend">
                        <div class="input-group-text">
                          <i class="fa fa-bar-chart-o"></i>
                        </div>
                      </div>
                      <input id="counted_items" name="counted_items" type="number" class="form-control margin-5" aria-describedby="counted_itemsHelpBlock" required />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row col-12 justify-content-center" style="padding-top: 10px">
              <div class="col-10 form-group row col-12 margin-10">
                <button name="update" class="styled-btn btn-blue" id="btn-count">Items Counted</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!--  -->
      <!-- Header -->
      <!--  -->
      <div class="header weight-800">Warehouse director</div>

      <!--  -->
      <!-- Sub Header -->
      <!--  -->
      <div class="sub-header">
        <div class="dropdown">
          <button class="styled-btn dropdown-toggle btn-blue" type="button" id="btn-filters" data-bs-toggle="dropdown" aria-expanded="false">Filters</button>
          <ul class="dropdown-menu btn-blue" aria-labelledby="btn-filters">
            <li><a class="dropdown-item" href="#">Most Recent</a></li>
            <li><a class="dropdown-item" href="#">Oldest</a></li>
            <li><a class="dropdown-item" href="#">Upcoming due date</a></li>
            <li><hr class="dropdown-divider" /></li>
          </ul>
        </div>
      </div>

      <div class="request-table" id="request-table-container"></div>
    </main>
  </body>
</html>
