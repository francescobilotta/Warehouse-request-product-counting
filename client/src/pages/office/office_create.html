<!DOCTYPE html>
<html lang="it">
<head>
    <title>Crea richesta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <link rel="icon" href="../../assets/img/favicon.png"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/css/selectize.bootstrap4.min.css"/>

    <link href="../../assets/css/common.css?1334423323" rel="stylesheet"/>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/js/standalone/selectize.min.js"></script>

    <script src="../../assets/js/request.js?122327565543334"></script>
    <script src="../../assets/js/generators.js?145753246253234"></script>
    <script src="../../assets/js/record_edit.js?1255345643374234"></script>
    <script src="../../assets/js/append_img_request_state.js?715563254232534"></script>
    <script src="../../assets/js/queries.js?132545752632534"></script>
    <script>
        function autocomplete_init(codes, descriptions) {
            const data = codes.map((code, index) => Object.fromEntries([["code", code], ["name", descriptions[index]]]))

            $('#prod_code').selectize({
                persist: false,
                maxItems: 1,
                valueField: 'code',
                labelField: 'code',
                searchField: ['code', 'name'],
                options: data,
                render: {
                    item: function (item, escape) {
                        return '<div>' +
                            (item.name ? '<span class="name">' + escape(item.code) + '</span>' : '') +
                            '</div>';
                    },
                    option: function (item, escape) {
                        let label = item.name || item.code;
                        return '<div>' +
                            '<span class="label">' + escape(item.code) + '</span>' +
                            '<div class="code-name-divider">|</div>' +
                            '<span class="label">' + escape(item.name) + '</span>' +
                            '</div>';
                    }
                },
            }).on("change", function (e) {
                const index = codes.indexOf($(this).val());
                update_fields($(this).val(), descriptions[index]);
            });
        }

        function update_fields(productId, description) {

            document.product_flavour_requester.query({
                q_name: "get_product_flavours",
                q_data: {"f.productCode": productId}
            });
            $('#prod_name').val(description);
        }

        function get_today() {
            const now = new Date();
            const day = ("0" + now.getDate()).slice(-2);
            const month = ("0" + (now.getMonth() + 1)).slice(-2);
            return now.getFullYear() + "-" + month + "-" + day;
        }

        function set_date() {
            const today = get_today();

            $("#date_due").val(today).attr({
                min: today,
            });
        }

        $("document").ready(() => {
            set_date();

            document.product_flavour_requester = new Requester(function (result) {
                if (!result.results.VARIANTE || !result.results.VARIANTE[0]) {
                    flavour_builder(['.'], "flavours-container");
                }
                else {
                    flavour_builder(result.results.VARIANTE, "flavours-container")
                }

            });

            document.product_codes_requester = new Requester(function (result) {
                autocomplete_init(result.results.COD_ARTICOLO, result.results.DESCRIZIONE)
            });

            document.product_codes_requester.query({
                q_name: "get_products_names"
            });

            document.request_create_sender = new Requester(function (result) {
                window.location.replace("office_homepage.html");
            });

            $('#create-form').submit((e) => {
                e.preventDefault(); // avoid to execute the actual submit of the form.
                const obj = {
                    q_name: "office_create_requests",
                    q_data: {
                        "d.requestDate": get_today(),
                        "d.productCode": $('#prod_code').val(),
                        "d.productName": $('#prod_name').val(),
                        "d.productFlavour": $("input[name='flavour']:checked").val(),
                        "d.dueDate": $('#date_due').val(),
                        "d.requestState": "countRequest",
                        "d.notes": $('#notes').val()
                    }
                };
                document.request_create_sender.query(obj);
            });
        });
    </script>
</head>
<body>
<main role="main" class="container">
    <div class="header weight-800">Crea Richesta<span class="blinker"></span></div>
    <div class="request-form">
        <form class="form" role="form" id="create-form">
            <div class="row">
                <label class="col-1 col-form-label">Prodotto</label>
                <div class="col">
                    <div class="row">
                        <div class="form-group col no-gutters">
                            <label class="col-12 col-form-label" for="prod_code">Codice Prodotto</label>
                            <div class="col-12">
                                <div style="margin-left: 0;" class="input-group">
<!--                                    <div class="input-group-prepend">-->
<!--                                        <div class="input-group-text"><i class="fa fa-tag"></i></div>-->
<!--                                    </div>-->
                                    <select id="prod_code" name="prod_code" class="form-control"
                                            aria-describedby="prod_codeHelpBlock" required="required"></select>
                                </div>
                                <span id="prod_codeHelpBlock" class="form-text text-muted"
                                >Inerisci i dati del prodotto e seleziona l'occorrenza corretta.</span
                                >
                            </div>
                        </div>
                        <div class="form-group col no-gutters">
                            <label for="prod_name" class="col-2 col-form-label">Prodotto</label>
                            <div class="col-12">
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <div class="input-group-text">
                                            <i class="fa fa-archive"></i>
                                        </div>
                                    </div>
                                    <input
                                            id="prod_name"
                                            name="prod_name"
                                            type="text"
                                            class="form-control"
                                            aria-describedby="prod_nameHelpBlock"
                                            required="required"
                                            readonly
                                    />
                                </div>
                                <span id="prod_nameHelpBlock" class="form-text text-muted">Descrizione del prodotto.</span>
                            </div>
                        </div>
                    </div>
                    <div class="row" id="flavours-container"></div>
                </div>
            </div>

            <div class="form-group row">
                <label for="notes" class="col-1 col-form-label">Note</label>
                <div class="col-11">
                    <textarea id="notes" name="notes" cols="40" rows="3" class="form-control"
                              aria-describedby="notesHelpBlock"></textarea>
                    <span id="notesHelpBlock" class="form-text text-muted">Aggiungi note alla richesta</span>
                </div>
            </div>
            <div class="form-group row">
                <input
                        hidden
                        id="date_creation"
                        name="date_creation"
                        type="text"
                        aria-describedby="date_creationHelpBlock"
                        required="required"
                        class="form-control"
                        readonly
                />
            </div>
            <div class="form-group row">
                <label for="date_due" class="col-1 col-form-label">Data Scadenza</label>
                <div class="col-11">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <div class="input-group-text">
                                <i class="fa fa-calendar"></i>
                            </div>
                        </div>
                        <input
                                id="date_due"
                                name="date_due"
                                type="date"
                                class="form-control"
                                aria-describedby="date_dueHelpBlock"
                                required="required"
                        />
                    </div>
                    <span id="date_dueHelpBlock" class="form-text text-muted">Data di scadenza della richiesta</span>
                </div>
            </div>

            <div class="form-group row col-12 justify-content-evenly">
                <button name="submit" type="submit" class="col-5 styled-btn btn-blue">Crea</button>
                    <a name="submit" type="submit" class="col-5 styled-btn btn-red-dark text-align-center no-text-decoration" href="office_homepage.html">Indietro</a>
            </div>
        </form>
    </div>
</main>
</body>
</html>
